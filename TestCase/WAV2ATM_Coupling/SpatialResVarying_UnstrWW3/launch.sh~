#!/bin/bash --login

#SBATCH --constraint=hatteras
#SBATCH --job-name=ww3standalone
#SBATCH -p batch
#SBATCH --time=72:00:00
#SBATCH -n 81
#SBATCH --mem-per-cpu=5GB
#SBATCH --mail-user=xychen@uri.edu
#SBATCH --mail-type=ALL
#SBATCH --output=ww3_testSSD.out
#SBATCH --error=ww3_testSSD.err


rootdir=/projects/ees/dhs-crc/xychen/NCEP-CPL-ADC-WW3/test_ssdWindStress
scptdir=$rootdir/script/bash
nemsdir=$rootdir/input/nems_configure
adcdir=$rootdir/input/adcirc
ww3dir=$rootdir/input/realww3
atmdir=$rootdir/input/wind
NEMSexe_orig=/home/xychen/ADC-WW3-NWM-NEMS/NEMS/exe_ww3
NEMSexe=/home/xychen/ADC-WW3-Coupling-Dev/SrcCode/NEMS/exe
#/ww3_PDLIB
adcexe=/home/xychen/ADC-WW3-Coupling-Dev/SrcCode/ADCIRC/work
ww3exe=/home/xychen/ADC-WW3-Coupling-Dev/SrcCode/WW3/model/exe
# modify work directory accordingly
runtype=atm2wav2ocn
#workdir=$rootdir/work/${runtype}_prototype_xycwork
workdir=`pwd`
np_adc=0
np_ww3=80
np_atm=1

# complete the following model run info:
totpets=$(( ${np_adc} + ${np_ww3} + ${np_atm} ))
echo totpets=$totpets
styear=2017
stmon=11
stday=24
sthr=1
stmin=0
stsec=0
nhr=120.0

if [[ ! -d $workdir ]]; then
   mkdir -p $workdir
fi
# enter work directory:
cd ${workdir}
rm -f PET*.*LogFile
rm -f wmesmf*.nc
rm -f field_*.nc
rm -f weightmatrix*.nc


if [[ 1 -eq 0 ]]; then
## ========= For NEMS ========== ##
# dynamically change the NEMS input files to reflect changes for different tests:
# manually change the following file to specify the wind and wave data used in the test.
cp ${nemsdir}/config.rc.${runtype}  config.rc
cp ${nemsdir}/nems.configure.${runtype}  nems.configure
#cp ${nemsdir}/model_configure .
cat ${nemsdir}/model_configure.sample  \
    | sed -e "s/#total_pets/${totpets}/g" \
         -e "s/#start_year/${styear}/g" \
         -e "s/#start_month/${stmon}/g" \
         -e "s/#start_day/${stday}/g" \
         -e "s/#start_hour/${sthr}/g" \
         -e "s/#start_minute/${stmin}/g" \
         -e "s/#start_second/${stsec}/g" \
         -e "s/#nhours/${nhr}/g" > model_configure
#fi

## ============== For WW3 ===================== ##
# build preparation directory for the three different grids:
#prep_dir1='grd_openocn'
#prep_dir2='grd_interm'
#prep_dir3='grd_fine'

#grdn_arry='openocn  interm  fine'
# change this to an unstructured mesh the same as the ADCIRC mesh:
	#  make several directory first to prepare different grids in the multi-grid mosaic system.
  	 mkdir grd_unstruc
	 cd grd_unstruc
	# copy necessary inputs to the directory:
	#  a. unstructured mesh file
	ln -s ${ww3dir}/bathy/Idealized_SemiCirc_Domain.msh  adcirc.msh
	#  c. ww3_grid.inp, ww3_multi.inp
	cp ${ww3dir}/ww3inps/ww3_grid_unstruc_adcirc.inp  ww3_grid.inp

        cp ${ww3dir}/ww3inps/ww3_ounf.inp .
	# execute ww3_grid:
	${ww3exe}/ww3_grid > grid.out
	 cd ../
        ln -s grd_unstruc/mod_def.ww3 mod_def.ADCIRC
ln -s grd_unstruc/mod_def.ww3 mod_def.points
cp ${ww3dir}/ww3inps/ww3_multi_NEMStest_atm2wav2ocn_unstrucWW3.inp ww3_multi.inp


#if [[ 1 -eq 0 ]]; then
## ============== For adcirc ================= ##
cp ${adcdir}/fort.15.${runtype}  fort.15
ln -s ${adcdir}/fort.14 .
ln -s ${adcdir}/fort.13 .
#fi 
# adcprep:
${adcexe}/adcprep --np ${np_adc} --partmesh
${adcexe}/adcprep --np ${np_adc} --prepall 
fi

#

## ================ launch NEMS.x ============== ##

#cp ${NEMSexe}/NEMS.x NEMS_PDLIB_index_orig.x   
#mpirun -np ${totpets} NEMS_cardeck.x
#mpirun -np ${totpets} NEMS_updated.x
#mpirun -np 81 NEMS_updated.x
#mpirun -np 81 NEMS_PDLIB_updated.x
mpirun -np 51 NEMS.x
#PDLIB_index_orig.x
#mpirun -np ${totpets} NEMS_xyctestv4.1.x

## =============== Retrieve information from WW3 ==================== ##
if [[ 1 -eq 0 ]]; then
for ig in $grdn_arry; do
  cd grd_$ig
  ln -s ../out_grd.$ig out_grd.ww3
  ${ww3exe}/ww3_ounf >ounf.out
  cd ../
done
fi
